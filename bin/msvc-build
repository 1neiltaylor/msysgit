#!/bin/sh

set -e

cd /git

test -d msvcgit || git clone git://repo.or.cz/msvcgit.git

vsvars=
type cl.exe 2> /dev/null ||
vsvars="$(ls -t \
	"$PROGRAMFILES/Microsoft Visual Studio"*/Common7/Tools/vsvars32.bat |
	head -n 1)"

config_mak=
test -f config.mak &&
config_mak=config.mak.bup.$$ &&
mv config.mak $config_mak

cat > config.mak << EOF
CFLAGS += -Imsvcgit/32bits/include
LDFLAGS += -Lmsvcgit/32bits/lib
EOF

cat > msvc-build.cmd << EOF
call "$vsvars"
make MSVC=1
EOF

cmd /c msvc-build.cmd

test -z "$config_mak" ||
mv $config_mak config.mak
